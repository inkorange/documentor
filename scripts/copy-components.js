#!/usr/bin/env node

/**
 * Copy source components to the website for live preview
 * This script copies component files from src/components to website/src/preview-components
 * so they can be dynamically imported in the documentation website
 */

const fs = require('fs');
const path = require('path');
const { glob } = require('glob');

const SOURCE_DIR = path.join(process.cwd(), 'src', 'components');
const TARGET_DIR = path.join(process.cwd(), 'website', 'src', 'preview-components');

async function copyComponents() {
  console.log('ðŸ“‹ Copying components for live preview...\n');

  // Create target directory if it doesn't exist
  if (!fs.existsSync(TARGET_DIR)) {
    fs.mkdirSync(TARGET_DIR, { recursive: true });
  }

  // Find all component files
  const componentFiles = await glob('**/*.{tsx,jsx,ts,js}', {
    cwd: SOURCE_DIR,
    ignore: ['**/*.test.{tsx,jsx,ts,js}', '**/*.spec.{tsx,jsx,ts,js}'],
  });

  console.log(`Found ${componentFiles.length} component files\n`);

  let copiedCount = 0;

  for (const file of componentFiles) {
    const sourcePath = path.join(SOURCE_DIR, file);
    const targetPath = path.join(TARGET_DIR, file);

    // Create target directory if needed
    const targetDir = path.dirname(targetPath);
    if (!fs.existsSync(targetDir)) {
      fs.mkdirSync(targetDir, { recursive: true });
    }

    // Read file content and strip 'use client' directive
    let content = fs.readFileSync(sourcePath, 'utf-8');

    // Remove 'use client' or "use client" directives (Next.js/RSC)
    content = content.replace(/^['"]use client['"];?\s*\n/m, '');

    // Write processed content
    fs.writeFileSync(targetPath, content, 'utf-8');
    console.log(`  âœ“ Copied ${file}`);
    copiedCount++;
  }

  // Also copy style files
  const styleFiles = await glob('**/*.{scss,css,module.scss,module.css}', {
    cwd: SOURCE_DIR,
  });

  for (const file of styleFiles) {
    const sourcePath = path.join(SOURCE_DIR, file);
    const targetPath = path.join(TARGET_DIR, file);

    const targetDir = path.dirname(targetPath);
    if (!fs.existsSync(targetDir)) {
      fs.mkdirSync(targetDir, { recursive: true });
    }

    fs.copyFileSync(sourcePath, targetPath);
    console.log(`  âœ“ Copied ${file}`);
    copiedCount++;
  }

  // Create an index file that exports all components
  await generateComponentIndex(componentFiles);

  console.log(`\nâœ… Copied ${copiedCount} files to website/src/preview-components`);
}

async function generateComponentIndex(componentFiles) {
  const indexPath = path.join(TARGET_DIR, 'index.ts');

  // Get unique component names (files without extension, at any depth)
  const components = componentFiles
    .filter(file => file.endsWith('.tsx') || file.endsWith('.jsx'))
    .map(file => {
      const parts = file.split('/');
      const fileName = parts[parts.length - 1];
      const componentName = fileName.replace(/\.(tsx|jsx)$/, '');
      const relativePath = './' + file.replace(/\.(tsx|jsx)$/, '');

      // Read the file to detect export type
      const filePath = path.join(TARGET_DIR, file);
      const fileContent = fs.readFileSync(filePath, 'utf-8');

      // Check if it uses named export (export const ComponentName) or default export
      const hasNamedExport = fileContent.includes(`export const ${componentName}`) ||
                             fileContent.includes(`export function ${componentName}`);
      const hasDefaultExport = fileContent.includes('export default');

      return {
        name: componentName,
        path: relativePath,
        isNamed: hasNamedExport && !hasDefaultExport
      };
    });

  const imports = components
    .map(({ name, path, isNamed }) => {
      if (isNamed) {
        return `import { ${name} } from '${path}';`;
      } else {
        return `import ${name} from '${path}';`;
      }
    })
    .join('\n');

  const exports = components
    .map(({ name }) => `export { ${name} };`)
    .join('\n');

  const content = `// Auto-generated file - do not edit manually
// This file is generated by scripts/copy-components.js

${imports}

${exports}

// Component registry for dynamic imports
export const COMPONENT_MAP: Record<string, any> = {
${components.map(({ name }) => `  '${name}': ${name},`).join('\n')}
};
`;

  fs.writeFileSync(indexPath, content, 'utf-8');
  console.log(`\n  âœ“ Generated index.ts with ${components.length} components`);

  // Log export types for debugging
  const namedExports = components.filter(c => c.isNamed).map(c => c.name);
  const defaultExports = components.filter(c => !c.isNamed).map(c => c.name);
  if (namedExports.length > 0) {
    console.log(`  â„¹ Named exports: ${namedExports.join(', ')}`);
  }
  if (defaultExports.length > 0) {
    console.log(`  â„¹ Default exports: ${defaultExports.join(', ')}`);
  }
}

// Run the script
copyComponents().catch(error => {
  console.error('Error copying components:', error);
  process.exit(1);
});
